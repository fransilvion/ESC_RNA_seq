---
title: "Pathway analysis of LINCS data"
author: "German Novakovskiy"
date: "August 23, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=FALSE}
library(knitr)
suppressWarnings(suppressMessages(library(tidyverse)))
suppressWarnings(suppressMessages(library(GEOquery)))
suppressWarnings(suppressMessages(library(data.table)))
suppressWarnings(suppressMessages(library(reshape2)))
suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(ggplot2)))
suppressWarnings(suppressMessages(library(cowplot)))
suppressWarnings(suppressMessages(library(limma)))
suppressWarnings(suppressMessages(library(tibble)))
suppressWarnings(suppressMessages(library(RColorBrewer)))
suppressWarnings(suppressMessages(library(edgeR)))
suppressWarnings(suppressMessages(library(readxl)))
suppressWarnings(suppressMessages(library(VennDiagram)))
suppressMessages(suppressWarnings(library(ermineR)))
suppressMessages(suppressWarnings(library(hgu133a.db)))
suppressMessages(suppressWarnings(library(ReactomePA)))
suppressMessages(suppressWarnings(library(clusterProfiler)))
suppressMessages(suppressWarnings(library(fgsea)))
suppressMessages(suppressWarnings(library(stringr)))
suppressMessages(suppressWarnings(library(rlist)))
```

# Loading and inspecting the data

Loading Gene expression data.

The Fold Change matrix itself. The data has been log2-transformed. The columns are individual comparisons (i.e. treatment vs control); the rows are genes. The column names are numbers mapping directly to the metadata row (in File 2 below); The row names are gene EntrezID Numbers (maps to pr_gene_id in Gene_Info.txt). 

```{r}
#gene_expression <- readRDS("~/GSEA_of_LINCS/fc.matrix.RDS.XZ")
#dim(gene_expression)
```

Loading metadata.

Metadata of the individual comparisons. There are 6 columns, with two main prefixes: trt_ for treatment, and ctl_for control. The metadata is derived from this file (GSE92742_Broad_LINCS_inst_info.txt.gz). The meanings of the columns: a) trt_type: Treatment type. Covers the range of compounds (cp), ligands (lig), knockdowns (sh) etc. Details covered in a table near the ends of the document here
(https://docs.google.com/document/d/1q2gciWRhVCAAnlvF2iRLuJ7whrGP6QjpsCMq1yWz7dU/edit#heading=h.l6bq0r1aih50)
b) trt_full: Full description of the treatment in the format: "$DOSE
$CHEMICAL for $TIME in $CELL"
c) ctl_type: Control type. Similar to (a) above, but covers vehicle only
(vehicle), empty vector (vector) and untreated (untrt).
d) ctl_full: Control description. Similar to (b)
e and f) trt_count and ctl_count: Number of samples for treatment and
control respectively.
```{r}
lincs_metadata <- readRDS("~/GSEA_of_LINCS/final.assign.mapping.RDS.XZ")

head(lincs_metadata)
```

Let's extract only those samples that come from MCF7 cell line:
```{r}
#pattern -> DOSAGE DRUG for TIME in CELL
trt_columns <- str_split_fixed(lincs_metadata$trt_full, " ", 6)

lincs_metadata <- lincs_metadata[,-2]

lincs_metadata <- cbind(lincs_metadata, trt_columns[,c(1,2,4,6)])

colnames(lincs_metadata) <- c("trt_type", "ctl_type", "ctl_full", "trt_count", "ctl_count",
                                   "dosage", "drug", "time", "cell")

#indexes (for expression columns)
x <- which(lincs_metadata$trt_type == "trt_cp" & lincs_metadata$cell == "MCF7" & lincs_metadata$time == "24h")

#we are interested only in compounds
lincs_metadata_mcf7 <- lincs_metadata %>% filter(trt_type == "trt_cp")

lincs_metadata_mcf7 <- lincs_metadata_mcf7 %>%
  filter(cell == "MCF7") %>%
  filter(time == "24h")

#add column of index
lincs_metadata_mcf7$Index <- x
dim(lincs_metadata_mcf7)
```

There are this amount of unique compounds for this data set:
```{r}
length(unique(lincs_metadata_mcf7$drug))
```

We have to leave only one instance of each drug in this data set:
```{r}
#first let's split the dosage column (looks like it only has uM concentrations)
test <- str_split_fixed(lincs_metadata_mcf7$dosage, "u", 2)
colnames(test) <- c("DOSE", "MOLE")
test <- as.data.frame(test)
test$DOSE <- as.numeric(as.character(test$DOSE))

lincs_metadata_mcf7 <- lincs_metadata_mcf7[,-6]

lincs_metadata_mcf7$dosage <- test$DOSE

repeated_drugs <- unique(lincs_metadata_mcf7$drug[which(duplicated(lincs_metadata_mcf7$drug))])

#function for removing repeats in the data frame (and live max dosage)
remove_repeats <- function(df, rep_drugs){
  new_copy_of_df <- cbind(df) #we created a copy
  
  for (drugRep in repeated_drugs){
    test <- lincs_metadata_mcf7 %>% filter(drug %in% drugRep)
    delete_indeces <- test$Index[-which(test$dosage == max(test$dosage))]
    new_copy_of_df <- new_copy_of_df %>%
      filter(!Index %in% delete_indeces)
  }
  
  return(new_copy_of_df)
}

lincs_metadata_mcf7 <- remove_repeats(lincs_metadata_mcf7, repeated_drugs)

#number of rows has to be 10627
dim(lincs_metadata_mcf7)
```

Analyze lincs expression data for only these selected drugs from MCF7
```{r}
#gene_expression_mcf7 <- gene_expression[,lincs_metadata_mcf7$Index]

#save(gene_expression_mcf7, file="gene_expression_mcf7.Rdata")
#rm(gene_expression)
```
```{r}
#if you run not the first time
load("gene_expression_mcf7.Rdata")
```


We have entrez gene ids, we will convert them to gene symbols via this file:
```{r}
gene_info <- read.table("~/GSEA_of_LINCS/Gene_Info.txt", header=TRUE, sep="\t", quote = "")
head(gene_info)
```
```{r}
entrez_genes <- rownames(gene_expression_mcf7)

#test2 - temporary df for conversion
test2 <- data.frame(pr_gene_id = entrez_genes)
test2 <- merge(test2, gene_info[,c(1,2)], sort=F)

#conversion
rownames(gene_expression_mcf7) <- test2$pr_gene_symbol
colnames(gene_expression_mcf7) <- lincs_metadata_mcf7$drug
```

Function for running GSEA:
```{r}
pathwaysKEGG <- gmtPathways("~/ESC_RNA_seq/pathway_enrichment_analysis/KeggPathways.gmt")
pathways_names <- names(pathwaysKEGG)

#helping function for building final data frame
is_significant <- function(pathway_name, df){
  if (!pathway_name %in% df$pathway){
    return(0)
  } else if (df[pathway==pathway_name]$ES > 0 & df[pathway==pathway_name]$padj <= 0.05){
    return(1)
  } else {
    return(0)
  }
}

#we use sizes 15 and 300 and 10000 permutations
#pathwaysKEGG and pathways_names must be specified in the environment!!!
running_fgsea <- function(expression_vector){
  fgseaRes <- fgsea(pathwaysKEGG, expression_vector, minSize=15, maxSize=300, nperm=10000)
  
  #we are interested in up-regulated pathways
  #fgseaRes <- fgseaRes %>% 
  #  arrange(padj) %>% 
  #  filter(NES > 0) %>% 
  #  filter(padj <= 0.05) %>% 
  #  dplyr::select(c("pathway", "padj", "ES", "NES", "nMoreExtreme"))
  
  res <- sapply(pathways_names, is_significant, fgseaRes)
  #return(fgseaRes)
  return(res)
}
```

```{r}
#let's analyze first 1000 drugs and write them into file
#it takes 30 minutes to run 1000 drugs
start.time <- Sys.time()
res1000 <- apply(gene_expression_mcf7[,c(1:1000)], 2, running_fgsea)
res1000 <- t(res1000)
end.time <- Sys.time()

time.taken <- end.time - start.time
time.taken

#save(res1000, file = "res1000.Rdata")
```
```{r}
#running analysis of all further drugs
#not efficient but I don't care here about it so much
res2000 <- apply(gene_expression_mcf7[,c(1001:2000)], 2, running_fgsea)
res2000 <- t(res2000)
save(res2000, file = "res2000.Rdata")
print("done with 2000")

###################################################################

res3000 <- apply(gene_expression_mcf7[,c(2001:3000)], 2, running_fgsea)
res3000 <- t(res3000)
save(res3000, file = "res3000.Rdata")
print("done with 3000")

###################################################################

res4000 <- apply(gene_expression_mcf7[,c(3001:4000)], 2, running_fgsea)
res4000 <- t(res4000)
save(res4000, file = "res4000.Rdata")
print("done with 4000")

###################################################################

res5000 <- apply(gene_expression_mcf7[,c(4001:5000)], 2, running_fgsea)
res5000 <- t(res5000)
save(res5000, file = "res5000.Rdata")
print("done with 5000")

###################################################################

res6000 <- apply(gene_expression_mcf7[,c(5001:6000)], 2, running_fgsea)
res6000 <- t(res6000)
save(res6000, file = "res6000.Rdata")
print("done with 6000")

###################################################################

res7000 <- apply(gene_expression_mcf7[,c(6001:7000)], 2, running_fgsea)
res7000 <- t(res7000)
save(res7000, file = "res7000.Rdata")
print("done with 7000")
rm(res7000)

###################################################################

res8000 <- apply(gene_expression_mcf7[,c(7001:8000)], 2, running_fgsea)
res8000 <- t(res8000)
save(res8000, file = "res8000.Rdata")
print("done with 8000")
rm(res8000)

###################################################################

res9000 <- apply(gene_expression_mcf7[,c(8001:9000)], 2, running_fgsea)
res9000 <- t(res9000)
save(res9000, file = "res9000.Rdata")
print("done with 9000")
rm(res9000)

###################################################################

res10000 <- apply(gene_expression_mcf7[,c(9001:10000)], 2, running_fgsea)
res10000 <- t(res10000)
save(res10000, file = "res10000.Rdata")
print("done with 10000")
rm(res10000)

###################################################################

res_final <- apply(gene_expression_mcf7[,c(10001:ncol(gene_expression_mcf7))], 2, running_fgsea)
res_final <- t(res_final)
save(res_final, file = "res_final.Rdata")
print("done with res_final")
rm(res_final)
```

Keep analyzing the enriched pathways in LINCS for MCF7:
```{r}
#combine all results into single data frame
load("res1000.Rdata")
all_drugs <- res1000
rm(res1000)

load("res2000.Rdata")
all_drugs <- rbind(all_drugs, res2000)
rm(res2000)

load("res3000.Rdata")
all_drugs <- rbind(all_drugs, res3000)
rm(res3000)

load("res4000.Rdata")
all_drugs <- rbind(all_drugs, res4000)
rm(res4000)

load("res5000.Rdata")
all_drugs <- rbind(all_drugs, res5000)
rm(res5000)

load("res6000.Rdata")
all_drugs <- rbind(all_drugs, res6000)
rm(res6000)

load("res7000.Rdata")
all_drugs <- rbind(all_drugs, res7000)
rm(res7000)

load("res8000.Rdata")
all_drugs <- rbind(all_drugs, res8000)
rm(res8000)

load("res9000.Rdata")
all_drugs <- rbind(all_drugs, res9000)
rm(res9000)

load("res10000.Rdata")
all_drugs <- rbind(all_drugs, res10000)
rm(res10000)

load("res_final.Rdata")
all_drugs <- rbind(all_drugs, res_final)
rm(res_final)

save(all_drugs, file="all_drugs_matrix.Rdata")
```

Analyzing results of pathway enrichment for all drugs:
```{r}
sum_across_all <- apply(all_drugs, 2, sum)

pathways <- names(sum_across_all)
sum_across_all <- as.data.frame(sum_across_all)
sum_across_all$Pathways <- pathways
sum_across_all <- sum_across_all %>% filter(sum_across_all > 0)
colnames(sum_across_all) <- c("Numbers", "Pathways")
sum_across_all <- sum_across_all[,c(2,1)]
sum_across_all <- sum_across_all[order(sum_across_all$Numbers, decreasing = TRUE),]

sum_across_all %>%
  head(25) %>%
  ggplot(aes(x = fct_reorder(Pathways, Numbers), 
             y = Numbers)) +
  geom_col(fill = "red", colour = "black") +
  labs(title = "Pathway numbers", 
       x = "", y = "Number of drugs") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() +
  theme_light()
```

We can see that among the most enriched pathways are ECM (extra cellular matrix) receptor interaction and focal adhesion, which probably makes sense, since it's a treatment of cells in some plates, they have to activate pathways that help them to interact with the environment.

Most underrepresented pathways:
```{r}
sum_across_all %>%
  tail(25) %>%
  ggplot(aes(x = fct_reorder(Pathways, Numbers), 
             y = Numbers)) +
  geom_col(fill = "blue", colour = "black") +
  labs(title = "Pathway numbers", 
       x = "", y = "Number of drugs") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() +
  theme_light()
```

Amount of drugs that have enriched pathways that are associated with DE differentiation (number of drugs for each pathway is independent from the others):
```{r}
sum_across_all %>%
  filter(Pathways %in% c("KEGG_WNT_SIGNALING_PATHWAY",
                         "KEGG_HEDGEHOG_SIGNALING_PATHWAY",
                         "KEGG_TGF_BETA_SIGNALING_PATHWAY",
                         "KEGG_PATHWAYS_IN_CANCER",
                         "KEGG_BASAL_CELL_CARCINOMA")) %>%
  ggplot(aes(x = fct_reorder(Pathways, Numbers), 
             y = Numbers)) +
  geom_col(fill = "blue", colour = "black") +
  labs(title = "Pathway numbers", 
       x = "", y = "Number of drugs") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() +
  theme_light()
```

Drugs that activate both Wnt and TGF beta pathways
```{r}
drugs <- rownames(all_drugs)
all_drugs <- as.data.frame(all_drugs)
rownames(all_drugs) <- drugs

test <- all_drugs %>%
  rownames_to_column("drug") %>%
  filter(KEGG_WNT_SIGNALING_PATHWAY == 1 &
           KEGG_TGF_BETA_SIGNALING_PATHWAY == 1)

#their names
test$drug
```
```{r}
test <- as.matrix(test)
rownames(test) <- test[,1]
test <- test[,-1]
test <- t(test)
```


First one is carbetocin:

![Carbetocin](Carbetocin.png)
It is an oxytocic used in obstetrics to control postpartum hemorrhage and bleeding after giving birth, particularly following Cesarean section.

It is also enriched for the following pathways:
```{r}
test %>%
  as.data.frame() %>%
  rownames_to_column("pathway") %>%
  filter(carbetocin == 1) %>%
  dplyr::select("pathway") %>% kable()
```
It is also enriched for HEMATOPOIETIC CELL LINEAGE pathway, which might be interesting, since hematopoietic cells are derived from mesoderm. Also it's enriched for prostate and lung cancer pathways, which also might point to some stem cell related process. Moreover, JAK/STAT might be beneficial for myogenesis: https://www.ncbi.nlm.nih.gov/pubmed/21388555


Second one is linifanib:

![Linifanib](Linifanib.png)
It is a structurally novel, potent inhibitor of receptor tyrosine kinases (RTK), vascular endothelial growth factor (VEGF) and platelet-derived growth factor (PDGF)

It is also enriched for the following pathways:
```{r}
test %>%
  as.data.frame() %>%
  rownames_to_column("pathway") %>%
  filter(linifanib == 1) %>%
  dplyr::select("pathway") %>% kable()
```
It is enriched for MAPK pathway, which is also required for definitive endoderm differentiation: https://www.ncbi.nlm.nih.gov/pubmed/22960178. Also ERBB, which is related to epidermal growth factors (EGF), which are beneficial for endoderm differentiation.

Third one is mestanolone:

![Mestanolone](Mestanolone.png)
It is an androgen and anabolic steroid (AAS) medication which is mostly no longer used.

It is also enriched for the following pathways:
```{r}
test %>%
  as.data.frame() %>%
  rownames_to_column("pathway") %>%
  filter(mestanolone == 1) %>%
  dplyr::select("pathway") %>% kable()
```
